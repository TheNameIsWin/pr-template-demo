name: PR Template Selector

on:
  pull_request:
    types: [opened, edited]

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read

jobs:
  template-selector:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine template
        id: template
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          echo "Changed files: $CHANGED_FILES"
          
          # Check if changes are in frontend folder (including subdirectories)
          if echo "$CHANGED_FILES" | grep -q "^frontend/"; then
            echo "template=frontend" >> $GITHUB_OUTPUT
            echo "ğŸ¨ Frontend changes detected - using frontend template"
          # Check if changes are in backend folder (including subdirectories)
          elif echo "$CHANGED_FILES" | grep -q "^backend/"; then
            echo "template=backend" >> $GITHUB_OUTPUT
            echo "âš™ï¸ Backend changes detected - using backend template"
          # Check for frontend file extensions
          elif echo "$CHANGED_FILES" | grep -qE "\.(jsx?|tsx?|css|scss|html|vue|svelte)$"; then
            echo "template=frontend" >> $GITHUB_OUTPUT
            echo "ğŸ¨ Frontend file types detected - using frontend template"
          # Check for backend file extensions
          elif echo "$CHANGED_FILES" | grep -qE "\.(js|ts|py|java|go|php|rb)$"; then
            echo "template=backend" >> $GITHUB_OUTPUT
            echo "âš™ï¸ Backend file types detected - using backend template"
          else
            echo "template=default" >> $GITHUB_OUTPUT
            echo "ğŸ“ Using default template"
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const template = '${{ steps.template.outputs.template }}';
            let message = '';
            
            if (template === 'frontend') {
              message = `ğŸ¨ **Frontend Changes Detected!**
              
              This PR contains frontend changes. The **Smart Template** is already loaded with frontend sections.
              
              **What to do:**
              - Fill out the "ğŸ¨ Frontend Changes" section
              - Delete the "âš™ï¸ Backend Changes" section if not needed
              - Complete the testing checklist
              
              **Frontend Features:**
              - UI/UX specific checkboxes
              - Browser compatibility testing
              - Responsive design checks
              - Screenshot requirements`;
            } else if (template === 'backend') {
              message = `âš™ï¸ **Backend Changes Detected!**
              
              This PR contains backend changes. The **Smart Template** is already loaded with backend sections.
              
              **What to do:**
              - Fill out the "âš™ï¸ Backend Changes" section
              - Delete the "ğŸ¨ Frontend Changes" section if not needed
              - Complete the testing checklist
              
              **Backend Features:**
              - Database change tracking
              - API documentation requirements
              - Security checklist
              - Performance considerations`;
            } else {
              message = `ğŸ“ **Mixed Changes Detected!**
              
              This PR contains both frontend and backend changes. The **Smart Template** includes both sections.
              
              **What to do:**
              - Fill out both "ğŸ¨ Frontend Changes" and "âš™ï¸ Backend Changes" sections
              - Complete the testing checklist
              - Delete any sections that don't apply`;
            }
            
            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
              console.log('âœ… Comment added successfully');
            } catch (error) {
              console.error('âŒ Error adding comment:', error);
              console.log('Template detected:', template);
              console.log('Message:', message);
              throw error;
            }
